'use strict';

/**
 * @ngdoc function
 * @name hiveTaskTrackerApp.controller:SettingsProfileCtrl
 * @description
 * # SettingsProfileCtrl
 * Controller of the hiveTaskTrackerApp
 */
angular.module('hiveTaskTrackerApp')
    .controller('SettingsProfileCtrl',
    ['$scope', '$timeout', '$element', '$q', 'HelperFormUtil', 'Member', 'HelperConfigUtil', '_',
        function ($scope, $timeout, $element, $q, HelperFormUtil, Member, HelperConfigUtil, _) {
            var editName =  $element.find('.name-edit'),
                name = $element.find('.name'),
                nameInput = $element.find('.name-edit-input');

            editName.hide();

            $scope.showEditName  = function () {
                name.hide();
                editName.show();
                nameInput.focus();
            };

            $scope.hideEditName = function () {
                editName.hide();
                name.show();
            };

            function findOtherUserByNickName(members, name) {
                return name ? _.find(members, function (member) {
                    //자신을 제외하고 동일한 이름을 찾는다.
                    return ( member.nickName === name && member.id !== HelperConfigUtil.loginUserId() );
                }) : null;
            }

            $scope.checkDuplicatedNickName = function (name) {
                return Member.fetchListWithoutPaging().then(function (members) {
                    return !findOtherUserByNickName(members, name);
                });
            };

            var $profileForm = $element.find('form[name=profileForm]');
            $scope.submit = function () {
                if ($scope.profileForm.$invalid || $scope.profileForm.$pending) {
                    $profileForm.find('.ng-invalid:first').focus();
                    return;
                }

                Member.changeNickName({userId: 'me', nickName: $scope.form.nickName}).then(function(){
                    $scope.hideEditName();
                });
            };

            function resetForm() {
                Member.fetchMyInfo().then(function (member) {
                    $scope.form = angular.copy(member);
                    HelperFormUtil.reset($scope.profileForm);
                });
            }
            resetForm();

            $scope.reset = function (event) {
                event.preventDefault();
                resetForm();
            };


        }]);
